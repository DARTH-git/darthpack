<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Testing • darthpack</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Testing">
<meta property="og:description" content="">
<meta property="og:image" content="https://darth-git.github.io/darthpack/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">darthpack</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/darthpack.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/aa-introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/bb-inputs.html">01 Model inputs</a>
    </li>
    <li>
      <a href="../articles/cc-model.html">02 Decision model</a>
    </li>
    <li>
      <a href="../articles/dd-calibration.html">03 Calibration</a>
    </li>
    <li>
      <a href="../articles/ee-validation.html">04 Validation</a>
    </li>
    <li>
      <a href="../articles/ff-analysis.html">05 Analysis</a>
    </li>
    <li>
      <a href="../articles/zz-testing.html">Testing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DARTH-git/darthpack">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Testing</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DARTH-git/darthpack/blob/master/vignettes/zz-testing.Rmd"><code>vignettes/zz-testing.Rmd</code></a></small>
      <div class="hidden name"><code>zz-testing.Rmd</code></div>

    </div>

    
    
<p>In this section, we use <code>testthat</code> package to demonstrate unit testing <span class="citation">(Wickham 2011)</span>. We first show the test structure used in the <code>testthat</code> package. We then demonstrate some unit tests for the functions in <code>02_simulation_model_functions.R</code>.</p>
<div id="test-structure" class="section level1">
<h1 class="hasAnchor">
<a href="#test-structure" class="anchor"></a><span class="header-section-number">1</span> Test structure</h1>
<p>A test file is a <code>.R</code> script and is normally stored separately from the source code. In the development of the Sick-Sicker project, we create a <code>tests</code> folder for all the test files. In practice, a developer often creates a test file corresponding to a file of source code. Because the functionalities in an R script are usually related, the tests in the corresponding test file naturally go together. A test file consists of three components from the lowest to the highest levels: <span style="color:blue">expectation</span>, <span style="color:blue">test</span> and <span style="color:blue">context</span> <span class="citation">(Wickham 2011)</span>.</p>
<ul>
<li>In general, an expectation is to verify whether or not part of a function or a process works as expected.</li>
<li>A test, consisting of a collection of exceptions, specifies which function or which part of a function is tested.</li>
<li>A context groups tests for related functionalities.</li>
</ul>
<p>An expectation is where the developer checks the expected behavior of the function or process of interest. For each expectation, we follow this coding flow:</p>
<ul>
<li>Generate the test data for/from the function or process of interest.</li>
<li>Hypothesize an expected effect of the function or process of interest.</li>
<li>Use <code>expect_</code> functions to verify whether the test data is as expected.</li>
</ul>
<p>The following coding structure is a general structure in a test file:</p>
<pre><code>context("testing whether the man in black (MIB) is a robot")

## 1st test
test_that("# of times MIB visited the Westworld", {
  # Generate test data. This might be a result from a function or a process. 
  a &lt;- number_of_time_from_MIB_memory()
  # An expected effect / value that might generated from the code that is under testing. 
  b1 &lt;- 1000
  expect_that(a, equals(b1)) # this is equivalent to expect_equal() in testthat
  
  # Use a different expected effect / value from the code that is tested. 
  b2 &lt;- number_of_time_dolores_met_MIB_in_the_park()
  expect_true(a &gt;= b2) 
})

## 2nd test
test_that("# of hosts MIB killed", {
  # Generate test data
  a &lt;- record_in_MIB_memory()
  # Get the expected value from a different function 
  b &lt;- record_store_in_Westworld()
  expect_equal(a, b)
})

## 3rd test
test_that("MIB's real name", {
  ...
})</code></pre>
<p>The text in the <code>context</code> function provides the name of the group of tests. By convention, one test file contains one <code>context()</code>, but the file can include more than one <code>context()</code>. Similarly, the text in the <code>test_that</code> function indicates which groups of expectations are being executed. After running the test files in the <code>R</code> console, the console would display whether the group of tests passed or failed. These texts in <code>context</code> and <code>test_that</code> would appear, allowing developers to quickly locate where the tests go wrong.</p>
</div>
<div id="example" class="section level1">
<h1 class="hasAnchor">
<a href="#example" class="anchor"></a><span class="header-section-number">2</span> Example</h1>
<p>The file <code>02_simulation_model_functions.R</code> includes function <code>decision_model</code>, which is the core code of the Markov model in the Sick-Sicker study. We show some example tests for <code>decision_model</code> here. In the following code, we test whether invalid input data evokes certain error message.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">context</span>(<span class="st">"testing 02_simulation_model_functions.R"</span>)

<span class="co"># get data for the input of decision_model()</span>
l_params_all &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_all_params.html">load_all_params</a></span>()

<span class="co"># tests</span>
<span class="kw">test_that</span>(<span class="st">"invalid inputs"</span>, {

  <span class="co"># We use an inaccurate input to raise a specific error message </span>
  <span class="co"># "Not all the age in the age range have a corresponding mortality rate" </span>
  l_params_all<span class="op">$</span>n_t &lt;-<span class="st"> </span><span class="dv">90</span>
  <span class="kw">expect_error</span>(<span class="kw"><a href="../reference/decision_model.html">decision_model</a></span>(l_params_all), 
               <span class="st">"Not all the age in the age range have a corresponding mortality rate"</span>)
  
  
  <span class="co"># We use an inaccurate input to raise a specific error message </span>
  <span class="co"># "vector of initial states (v_s_init) is not valid" </span>
  l_params_all<span class="op">$</span>n_t &lt;-<span class="st"> </span><span class="dv">75</span>
  l_params_all<span class="op">$</span>v_s_init &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">H =</span> <span class="op">-</span><span class="dv">1</span>, <span class="dt">S1 =</span> <span class="dv">0</span>, <span class="dt">S2 =</span> <span class="dv">0</span>, <span class="dt">D =</span> <span class="dv">0</span>)
  <span class="kw">expect_error</span>(<span class="kw"><a href="../reference/decision_model.html">decision_model</a></span>(l_params_all), 
               <span class="st">"vector of initial states </span><span class="ch">\\</span><span class="st">(v_s_init</span><span class="ch">\\</span><span class="st">) is not valid"</span>)
})</code></pre></div>
<p>To test invalid inputs for <code>decision_model</code>, we need to pass the input data to the function by loading the parameters. In the tests, we use invalid value for an input parameter that guarantees an error message. Because we expect an error to occur, we use <code>expect_error</code> to assert whether <code><a href="../reference/decision_model.html">decision_model(l_params_all)</a></code> generates the same error message as expected. Because we create invalid inputs to meet these expectation of error message, running this block of code will not raise any error in the console.</p>
<p>Here is another group of tests checking on the output of <code>decision_model</code>. We use more <code>expect_</code> functions to check different aspects of the outputs, including the number of components, the naming, the values, etc.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">test_that</span>(<span class="st">"correct outputs"</span>, {
  ## generate output data from decision_model
  output &lt;-<span class="st"> </span><span class="kw"><a href="../reference/decision_model.html">decision_model</a></span>(l_params_all, <span class="dt">err_stop =</span> F, <span class="dt">verbose =</span> F)
  
  ## checking overall outputs
  <span class="co"># check the number of elements in the output</span>
  <span class="kw">expect_equal</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(output), <span class="dv">2</span>)
  <span class="co"># check whether both the outputs are array type</span>
  <span class="kw">expect_true</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/all">all</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(output, is.array))))
  <span class="co"># check whether the output names are identical as expected </span>
  <span class="kw">expect_identical</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(output), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"a_P"</span>, <span class="st">"m_M"</span>))
  
  ## checking output 1: a_P (the transition probability array)
  <span class="co"># check whether the dimension of a_P is as expected</span>
  <span class="kw">expect_equal</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(output[[<span class="dv">1</span>]]), 
               <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(l_params_all<span class="op">$</span>n_states, l_params_all<span class="op">$</span>n_states, l_params_all<span class="op">$</span>n_t))
  <span class="co"># check whether all the transition probability is between 0 and 1</span>
  <span class="kw">expect_true</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/all">all</a></span>(output[[<span class="dv">1</span>]] <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">|</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/all">all</a></span>(output[[<span class="dv">1</span>]] <span class="op">&lt;=</span><span class="st"> </span><span class="dv">1</span>))
  <span class="co"># check whether all rows of each transition matrix sum up to 1 (sum_to_1)</span>
  <span class="co"># because the sums are not numerically equal to 1, we made some adjustment (correct_small_digits)</span>
  sum_to_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(output[[<span class="dv">1</span>]], <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(x)) 
  correct_small_digits &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(sum_to_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span><span class="dv">100</span>) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>
  <span class="kw">expect_true</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/all">all</a></span>(correct_small_digits <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))
  
  ## checking output 2: m_M (trace matrix)
  <span class="co"># check whether the dimension of m_M is as expected</span>
  <span class="kw">expect_equal</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(output[[<span class="dv">2</span>]]), 
               <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(l_params_all<span class="op">$</span>n_t <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, l_params_all<span class="op">$</span>n_states))
  <span class="co"># check whether each row in m_M sums up to 1 (sum_to_1)</span>
  <span class="co"># because the sumes are not numerically equal to 1, we made some adjustment (correct_small_digits)</span>
  sum_to_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">rowSums</a></span>(output[[<span class="dv">2</span>]])
  correct_small_digits &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(sum_to_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span><span class="dv">100</span>) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>
  <span class="kw">expect_true</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/all">all</a></span>(correct_small_digits <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))
  <span class="kw">expect_true</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/all">all</a></span>(output[[<span class="dv">2</span>]] <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>output[[<span class="dv">2</span>]] <span class="op">&lt;=</span><span class="st"> </span><span class="dv">1</span>))
})</code></pre></div>
<p>In the test file, we also include tests for the other two functions <code>check_transition_probability</code> and <code>check_sum_of_transition_array</code>. In addition, we made another testing file <code>test_05a_deterministic_analysis_functions.R</code> for function <code>calculate_ce_out</code>.</p>
</div>
<div id="run-tests" class="section level1">
<h1 class="hasAnchor">
<a href="#run-tests" class="anchor"></a><span class="header-section-number">3</span> Run tests</h1>
<p>There are multiple ways to run test files with <code>testthat</code> in R.</p>
<div id="run-each-file-directly" class="section level2">
<h2 class="hasAnchor">
<a href="#run-each-file-directly" class="anchor"></a><span class="header-section-number">3.1</span> Run each file directly</h2>
<p>In this case, the library <code>testthat</code> should be attached before running a test file. If all tests in the file passed (that is, all expectations are met), no error messages are raised in the console. However, sometimes the developer might loss count of the number of tests or loss track of the type of tests. This method is not informative in informing how many tests passed, and where the error occurs if tests failed.</p>
</div>
<div id="run-test-files-at-once-for-an-r-project-package" class="section level2">
<h2 class="hasAnchor">
<a href="#run-test-files-at-once-for-an-r-project-package" class="anchor"></a><span class="header-section-number">3.2</span> Run test files at once for an R project / package</h2>
<p>For an R package, the developer can run all the test files using shortcut <code>Ctrl/Cmd+Shift+T</code> or type R command <code><a href="https://www.rdocumentation.org/packages/testthat/topics/test_dir">testthat::test_dir("path/to/the/tests/folder")</a></code> in the console. The shortcut does not work for an R project. RStudio will then provide a summary of passed, failed, and skipped tests.</p>
<div class="figure">
<img src="../vignettes/test_summary.png" width="500">
</div>
<p>We could see tests are grouped by context, and all our 27 tests passed.</p>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-testthat">
<p>Wickham, Hadley. 2011. “Testthat: Get Started with Testing.” <em>The R Journal</em> 3: 5–10. <a href="https://journal.r-project.org/archive/2011-1/RJournal_2011-1_Wickham.pdf" class="uri">https://journal.r-project.org/archive/2011-1/RJournal_2011-1_Wickham.pdf</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Fernando Alarid-Escudero, Eline Krijkamp, Petros Pechlivanoglou, Hawre Jalal, Szu-Yu Kao, Alan Yang, Eva Enns.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
