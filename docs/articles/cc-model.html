<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>02 Decision model â€¢ darthpack</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="02 Decision model">
<meta property="og:description" content="">
<meta property="og:image" content="https://darth-git.github.io/darthpack/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">darthpack</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/darthpack.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/aa-introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/bb-inputs.html">01 Model inputs</a>
    </li>
    <li>
      <a href="../articles/cc-model.html">02 Decision model</a>
    </li>
    <li>
      <a href="../articles/dd-calibration.html">03 Calibration</a>
    </li>
    <li>
      <a href="../articles/ee-validation.html">04 Validation</a>
    </li>
    <li>
      <a href="../articles/ff-analysis.html">05 Analysis</a>
    </li>
    <li>
      <a href="../articles/zz-testing.html">Testing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DARTH-git/darthpack">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>02 Decision model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DARTH-git/darthpack/blob/master/vignettes/cc-model.Rmd"><code>vignettes/cc-model.Rmd</code></a></small>
      <div class="hidden name"><code>cc-model.Rmd</code></div>

    </div>

    
    
<div id="simulation" class="section level1">
<h1 class="hasAnchor">
<a href="#simulation" class="anchor"></a><span class="header-section-number">1</span> Decision model</h1>
<p>In this second component, we build the backbone of the decision analysis: the implementation of the model. This component is performed by the <em>02_decision_model.R</em> script. This file itself is not very large. It simply loads some packages and sources the input from component 01 and in addition it runs the <code>decision_model</code> function that is used to capture the dynamic process of the Sick-Sicker example and stores the output. The output of the model is the traditional cohort trace. The trace describes how the cohort is distributed among the different health states over time and is plotted at the end of this script.</p>
<p>The function <code>decision_model</code> is defined in the <em>02_decision_model_functions.R</em> file in the <code>R</code> folder. As described in the paper, constructing a model as a function at this stage facilitates subsequent stages of the model development and analysis. This since these processes will all call the same model function, but pass different parameter values and/or calculate different final outcomes based on the model outputs. In the next part, we will describe the code within the function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print.function</a></span>(decision_model) <span class="co"># print the code of the function</span>
<span class="co">#&gt; function(l_params_all, err_stop = FALSE, verbose = FALSE){ # User defined</span>
<span class="co">#&gt;   </span><span class="al">###</span><span class="co"> Definition:</span>
<span class="co">#&gt;   ##   Decision model implementation function</span>
<span class="co">#&gt;   </span><span class="al">###</span><span class="co"> Arguments:  </span>
<span class="co">#&gt;   ##   l_params_all: List with all parameters of decision model</span>
<span class="co">#&gt;   ##   verbose: Logical variable to indicate print out of messages</span>
<span class="co">#&gt;   </span><span class="al">###</span><span class="co"> Returns:</span>
<span class="co">#&gt;   ##   a_P: Transition probability array</span>
<span class="co">#&gt;   ##   m_M: Matrix cohort trace</span>
<span class="co">#&gt;   ##</span>
<span class="co">#&gt;   with(as.list(l_params_all), {</span>
<span class="co">#&gt;     #### Error checking ####</span>
<span class="co">#&gt;     if ((n_t + n_age_init) &gt; nrow(v_r_mort_by_age)) {</span>
<span class="co">#&gt;       stop("Not all the age in the age range have a corresponding mortality rate")</span>
<span class="co">#&gt;     }</span>
<span class="co">#&gt;     </span>
<span class="co">#&gt;     if ((sum(v_s_init) != 1) | !all(v_s_init &gt;= 0)) {</span>
<span class="co">#&gt;       stop("vector of initial states (v_s_init) is not valid")</span>
<span class="co">#&gt;     }</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     #### Age-specific transition probabilities ####</span>
<span class="co">#&gt;     # Mortality for healthy individuals</span>
<span class="co">#&gt;     p_HDage  &lt;- 1 - exp(-v_r_mort_by_age[(n_age_init + 1) + 0:(n_t - 1)])        </span>
<span class="co">#&gt;     # Mortality for sick individuals</span>
<span class="co">#&gt;     p_S1Dage &lt;- 1 - exp(-v_r_mort_by_age[(n_age_init + 1) + 0:(n_t - 1)] * hr_S1)</span>
<span class="co">#&gt;     # Mortality for sicker individuals</span>
<span class="co">#&gt;     p_S2Dage &lt;- 1 - exp(-v_r_mort_by_age[(n_age_init + 1) + 0:(n_t - 1)] * hr_S2)</span>
<span class="co">#&gt;     </span>
<span class="co">#&gt;     #### Create age-specific transition probability matrices in an array ####</span>
<span class="co">#&gt;     # Initialize array</span>
<span class="co">#&gt;     a_P &lt;- array(0, dim = c(n_states, n_states, n_t),</span>
<span class="co">#&gt;                  dimnames = list(v_n, v_n, 0:(n_t-1)))</span>
<span class="co">#&gt;     # Fill in array</span>
<span class="co">#&gt;     # From H</span>
<span class="co">#&gt;     a_P["H", "H", ]  &lt;- (1-p_HDage) * (1 - p_HS1)</span>
<span class="co">#&gt;     a_P["H", "S1", ] &lt;- (1-p_HDage) * p_HS1</span>
<span class="co">#&gt;     a_P["H", "D", ]  &lt;- p_HDage</span>
<span class="co">#&gt;     # From S1</span>
<span class="co">#&gt;     a_P["S1", "H", ]  &lt;- (1-p_S1Dage) * p_S1H</span>
<span class="co">#&gt;     a_P["S1", "S1", ] &lt;- (1-p_S1Dage) * (1 - (p_S1S2 + p_S1H))</span>
<span class="co">#&gt;     a_P["S1", "S2", ] &lt;- (1-p_S1Dage) * p_S1S2</span>
<span class="co">#&gt;     a_P["S1", "D", ]  &lt;- p_S1Dage</span>
<span class="co">#&gt;     # From S2</span>
<span class="co">#&gt;     a_P["S2", "S2", ] &lt;- 1 - p_S2Dage</span>
<span class="co">#&gt;     a_P["S2", "D", ]  &lt;- p_S2Dage</span>
<span class="co">#&gt;     # From D</span>
<span class="co">#&gt;     a_P["D", "D", ] &lt;- 1</span>
<span class="co">#&gt;     </span>
<span class="co">#&gt;     #### Check if transition array is valid ####</span>
<span class="co">#&gt;     check_transition_probability(a_P, err_stop = err_stop, verbose = verbose)</span>
<span class="co">#&gt;     check_sum_of_transition_array(a_P, n_states, n_t, err_stop = err_stop, verbose = verbose)</span>
<span class="co">#&gt;     </span>
<span class="co">#&gt;     #### Compute cohort trace matrix and transition array for age-dependent STM ####</span>
<span class="co">#&gt;     # Initialize cohort trace matrix</span>
<span class="co">#&gt;     m_M &lt;- matrix(0, </span>
<span class="co">#&gt;                   nrow = (n_t + 1), ncol = n_states, </span>
<span class="co">#&gt;                   dimnames = list(0:n_t, v_n))</span>
<span class="co">#&gt;     # Set first row of m.M with the initial state vector</span>
<span class="co">#&gt;     m_M[1, ] &lt;- v_s_init</span>
<span class="co">#&gt;     </span>
<span class="co">#&gt;     # Iterate STM over time</span>
<span class="co">#&gt;     for(t in 1:n_t){</span>
<span class="co">#&gt;       m_M[t + 1, ] &lt;- m_M[t, ] %*% a_P[, , t]</span>
<span class="co">#&gt;     }</span>
<span class="co">#&gt;     return(list(a_P = a_P,</span>
<span class="co">#&gt;                 m_M = m_M))</span>
<span class="co">#&gt;   }</span>
<span class="co">#&gt;   )</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; &lt;bytecode: 0x7fcf4af1f600&gt;</span>
<span class="co">#&gt; &lt;environment: namespace:darthpack&gt;</span></code></pre></div>
<p>The <code>decision_model</code> function is informed by the argument <code>l_params_all</code>. Via this argument we give the function a list with all parameters of the decision model. For the Sick-Sicker model, these parameters are stored in the list <code>l_params_all</code>, which we passed into the function as shown below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">l_out_stm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/decision_model.html">decision_model</a></span>(<span class="dt">l_params_all =</span> l_params_all) <span class="co"># run the function</span></code></pre></div>
<p>This function itself has all the mathematical equations of the decision models coded inside. It starts by calculating the age-specific transition probabilities from all non-dead states based on the vector of age-specific mortality rates <code>v_r_mort_by_age</code>. These parameters will become vectors of length <code>n_t</code>, describing the probability to die for all ages from all non-dead states.</p>
<p>The next part of the function, creates an array that stores age-specific transition probability matrices in each of the third dimension. The transition probability matrix is a core component of a state-transition cohort model <span class="citation">[@Iskandar2018]</span>. This matrix contains the probabilities of transitioning from the current health state, indicated by the rows, to the other health states, specified by the columns. Since we have age-specific transition probabilities, the transition probability matrix is different each cycle. These probabilities are only depending on the age of the cohort, and not on other events; therefore, we can generate all matrices at the start of the model. This results in <code>n_t</code> different age-specific matrices that are stored in an array, called <code>a_P</code>, of dimensions <code>n_states</code> x <code>n_states</code> x <code>n_t</code>. After initializing the array, it is filled with the transition probability stored in the list. When running the model, we can index the correct transition probability matrix corresponding with the current age of the cohort. We then added some sanity checks to make sure that the transition matrices and the transition probabilities are valid. The first three and last cycles of the transition probability matrices stored in the array <code>a.P</code> are shown below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">l_out_stm<span class="op">$</span>a_P[, , <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>] <span class="co"># show the first three time-points of a_P</span>
<span class="co">#&gt; , , 0</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;            H        S1        S2           D</span>
<span class="co">#&gt; H  0.8491385 0.1498480 0.0000000 0.001013486</span>
<span class="co">#&gt; S1 0.4984813 0.3938002 0.1046811 0.003037378</span>
<span class="co">#&gt; S2 0.0000000 0.0000000 0.9899112 0.010088764</span>
<span class="co">#&gt; D  0.0000000 0.0000000 0.0000000 1.000000000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; , , 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;            H        S1        S2            D</span>
<span class="co">#&gt; H  0.8491513 0.1498502 0.0000000 0.0009985012</span>
<span class="co">#&gt; S1 0.4985037 0.3938180 0.1046858 0.0029925135</span>
<span class="co">#&gt; S2 0.0000000 0.0000000 0.9900597 0.0099402657</span>
<span class="co">#&gt; D  0.0000000 0.0000000 0.0000000 1.0000000000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; , , 2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;            H        S1        S2           D</span>
<span class="co">#&gt; H  0.8490910 0.1498396 0.0000000 0.001069428</span>
<span class="co">#&gt; S1 0.4983976 0.3937341 0.1046635 0.003204853</span>
<span class="co">#&gt; S2 0.0000000 0.0000000 0.9893570 0.010642959</span>
<span class="co">#&gt; D  0.0000000 0.0000000 0.0000000 1.000000000</span>
l_out_stm<span class="op">$</span>a_P[, , l_params_all<span class="op">$</span>n_t] <span class="co"># show it for the last cycle</span>
<span class="co">#&gt;            H        S1         S2         D</span>
<span class="co">#&gt; H  0.6055199 0.1068564 0.00000000 0.2876237</span>
<span class="co">#&gt; S1 0.1807584 0.1427991 0.03795926 0.6384833</span>
<span class="co">#&gt; S2 0.0000000 0.0000000 0.03365849 0.9663415</span>
<span class="co">#&gt; D  0.0000000 0.0000000 0.00000000 1.0000000</span></code></pre></div>
<p>By comparing these probability matrices, we observe an increase in the probabilities of transitioning to death from all health states.</p>
<p>After the array is filled, the cohort trace matrix, <code>m_M</code>, of dimensions <code>n_t</code> x <code>n_states</code> is initialized. This matrix will store the state occupation at each point in time. The first row of the matrix is informed by the initial state vector <code>v_s_init</code>. For the remaining points in time, we iteratively multiply the cohort trace with the age-specific transition probability matrix corresponding to the specific cycle obtained by indexing the array <code>a_P</code> appropriately. All the outputs and relevant elements of the decision model are stored in a list, called <code>l_out_stm</code>. This list contains the array of the transition probability matrix for all cycles <code>t</code> and the cohort trace <code>m_M</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(l_out_stm<span class="op">$</span>m_M)    <span class="co"># show the top part of the cohort trace</span>
<span class="co">#&gt;           H        S1         S2           D</span>
<span class="co">#&gt; 0 1.0000000 0.0000000 0.00000000 0.000000000</span>
<span class="co">#&gt; 1 0.8491385 0.1498480 0.00000000 0.001013486</span>
<span class="co">#&gt; 2 0.7957468 0.1862564 0.01568695 0.002309774</span>
<span class="co">#&gt; 3 0.7684912 0.1925699 0.03501425 0.003924648</span>
<span class="co">#&gt; 4 0.7484793 0.1909659 0.05478971 0.005765035</span>
<span class="co">#&gt; 5 0.7306193 0.1873106 0.07413838 0.007931783</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">tail</a></span>(l_out_stm<span class="op">$</span>m_M)    <span class="co"># show the bottom part of the cohort trace</span>
<span class="co">#&gt;              H           S1           S2         D</span>
<span class="co">#&gt; 70 0.009928317 0.0022433565 2.035951e-04 0.9876247</span>
<span class="co">#&gt; 71 0.007153415 0.0015935925 1.311619e-04 0.9911218</span>
<span class="co">#&gt; 72 0.005058845 0.0011174473 8.674540e-05 0.9937370</span>
<span class="co">#&gt; 73 0.003460336 0.0007552206 5.436484e-05 0.9957301</span>
<span class="co">#&gt; 74 0.002289594 0.0004937081 3.298632e-05 0.9971837</span>
<span class="co">#&gt; 75 0.001475636 0.0003151589 1.985106e-05 0.9981894</span></code></pre></div>
<p>Using the code below, we can graphically show the model dynamics by plotting the cohort trace. Figure <a href="#fig:Sick-Sicker-Trace">1.1</a> shows the distribution of the cohort among the different health states at each time point.</p>
<div class="figure">
<span id="fig:Sick-Sicker-Trace"></span>
<img src="cc-model_files/figure-html/Sick-Sicker-Trace-1.png" alt="Cohort trace of the Sick-Sicker cohort model" width="672"><p class="caption">
Figure 1.1: Cohort trace of the Sick-Sicker cohort model
</p>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Fernando Alarid-Escudero, Eline Krijkamp, Petros Pechlivanoglou, Hawre Jalal, Szu-Yu Kao, Alan Yang, Eva Enns.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
